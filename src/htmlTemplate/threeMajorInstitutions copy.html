<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三大法人</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

</head>
<body>
    <div class="w-[800px]">
        <div id="main" class="w-[800px] h-[500px]"></div>
    </div>
</body>
<script>
    // 外資、投信、自營
    const STOCK_ID = '2330'
    const START_DATE = '2022-01-01'
    const url = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockInstitutionalInvestorsBuySell&data_id=${STOCK_ID}&start_date=${START_DATE}`

    // let stockData;
    const KChart = echarts.init(document.getElementById('main'))

    async function getData() {
        try{
            const respon = await fetch(url)
            return await respon.json()
        }catch(error){
            console.error('取得資料失敗:',error)    
        }  
    } 
    //x軸日期陣列
    function institutionalTrading() {
        const originalDate = stockData.data.map( item => item.date)
        //x軸日期陣列
        const datesArray = new Set(originalDate)
        const originalTrusts = stockData.data.filter( item => 
            item.name === 'Investment_Trust'
        )
        //投信陣列
        const trustsArray = originalTrusts.map( item =>
            item.buy + item.sell
        )
        //外資(Foreign_Investor、Foreign_Dealer_Self)
        const originalForeign = stockData.data.filter( item => 
            item.name === 'Foreign_Investor' || item.name === 'Foreign_Dealer_Self' 
        )
        const groupForeign = originalForeign.reduce((acc,item) => {
            const lastArray = acc[acc.length - 1]
            if(acc.length == 0 || lastArray[0].date !== item.date){
                acc.push([item])
            }else{
                lastArray.push(item)
            }
            return acc
        },[])
        // 外資陣列
        const foreignsArray = groupForeign.map(item => {
          return  ( item[0].buy + item[0].sell ) + ( item[1].buy + item[1].sell )
        })

        //自營商(Dealer_self、Dealer_Hedging)
        const originaldDaler = stockData.data.filter( item => {
           return item.name === 'Dealer_self' || item.name === 'Dealer_Hedging'
        })
        const groupDaler = originaldDaler.reduce((acc,item) => {
            //正在建立的組
            const lastArray = acc[acc.length - 1]
            
            if(acc.length === 0 || lastArray[0].date != item.date) {
                acc.push([item])
            }else {
                lastArray.push(item)
            }
            return acc
        },[])
        //自營商陣列
        const dalersArray = groupDaler.map(item => {
            return (item[0].buy + item[0].sell) + (item[1].buy + item[0].sell) 
        })
       
        // console.log('dalerArray',dalersArray)
    }
    //繪圖
    // function drawChart() {
        
    // }
  
    getData().then(() => {
        console.log(stockData)
        institutionalTrading() 
    })
</script>
</html>